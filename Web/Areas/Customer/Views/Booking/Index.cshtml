@model Web.Models.ViewModels.SeatBookingViewModel
@{
    ViewData["Title"] = "Book Ticket";
}

@section Styles {
    <link rel="stylesheet" href="~/css/customer/booking/booking.css" asp-append-version="true" />
}

@Html.AntiForgeryToken()

<!-- Step Indicator -->
<div class="step-indicator">
    <div class="container">
        <div class="row">
            <div class="col-3">
                <div class="step-item active">
                    <div class="step-icon">
                        <i class="fas fa-th"></i>
                    </div>
                    <span>Chọn ghế</span>
                </div>
            </div>
            <div class="col-3">
                <div class="step-item">
                    <div class="step-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <span>Bắp nước</span>
                </div>
            </div>
            <div class="col-3">
                <div class="step-item">
                    <div class="step-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <span>Thanh toán</span>
                </div>
            </div>
            <div class="col-3">
                <div class="step-item">
                    <div class="step-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <span>Thông tin vé</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fixed Action Buttons -->
<div class="action-buttons fade-in">
    <div class="row g-3">
        <div class="col-4">
            <a href="@Url.Action("Index", "Movie")" class="btn btn-custom btn-back w-100">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
        <div class="col-8">
            <a class="btn btn-custom btn-continue w-100" id="continue-btn" disabled>
                <span class="d-md-none">
                    <span id="mobile-total">0</span>₫ |
                </span>
                <span>Tiếp tục</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container booking-content">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-4 order-lg-2">
            <!-- Movie Info -->
            <div class="movie-info-card fade-in">
                <div class="movie-title">@Model.MovieTitle</div>
                <div class="cinema-name">@Model.TheaterName</div>
                <div class="showtime">
                    <i class="fas fa-clock"></i> Suất <strong>
                        @Model.ShowtimeTime.ToString("HH:mm")
                        @Model.ShowtimeDate.ToString("dd/MM/yyyy")
                    </strong><br>
                    <i class="fas fa-map-marker-alt"></i> Phòng chiếu <strong>@Model.ScreenName</strong> - Ghế <span
                        id="selected-seats">...</span>
                </div>
            </div>

            <!-- Total -->
            <div class="total-card fade-in">
                <div class="total-section-label">TỔNG ĐƠN HÀNG</div>
                <div class="total-amount">
                    <span id="total-amount">0</span> ₫
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-8 order-lg-1">
            <div class="cinema-hall fade-in">
                <!-- Screen -->
                <div class="screen">
                    <i class="fas fa-tv me-2"></i>MÀN HÌNH
                </div>

                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-seat selected"></div>
                        <span>Ghế bạn chọn</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-seat unavailable"></div>
                        <span>Không thể chọn</span>
                    </div>
                </div>

                <!-- Include the SeatMap partial view -->
                @await Html.PartialAsync("_SeatMap", Model)
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/customer/booking/movie-booking.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize seats when the partial view is loaded
            if (typeof initializeSeats === 'function') {
                initializeSeats();
            }

            // Handle continue button click
            document.getElementById('continue-btn').addEventListener('click', function (e) {
                e.preventDefault();

                if (selectedSeats && selectedSeats.length > 0) {
                    // Hiển thị loading spinner
                    Swal.fire({
                        title: 'Đang xử lý...',
                        text: 'Vui lòng đợi trong giây lát',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Chuẩn bị dữ liệu booking theo BookingCreateDTO
                    const bookingData = {
                        showTimeId: @Model.ShowtimeId,
                        bookingDetails: selectedSeats.map(s => ({
                            seatId: parseInt(s.id),
                            seatPrice: s.price,
                            seatName: s.code
                        }))
                    };

                    // Gọi API để tạo booking trong database
                    fetch('@Url.Action("CreateBooking", "Booking")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify(bookingData)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.href = data.redirect || '@Url.Action("Concession", "Booking")';
                            } else {
                                // Hiển thị lỗi nếu có
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Lỗi',
                                    text: data.message || 'Đã xảy ra lỗi khi đặt chỗ. Vui lòng thử lại.'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: 'Đã xảy ra lỗi khi đặt chỗ. Vui lòng thử lại.'
                            });
                        });
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Chưa chọn ghế',
                        text: 'Vui lòng chọn ít nhất một ghế để tiếp tục'
                    });
                }
            });
        });
    </script>
}
