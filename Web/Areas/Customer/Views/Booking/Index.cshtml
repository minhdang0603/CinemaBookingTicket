@{
    ViewData["Title"] = "Book Ticket";
}

@section Styles {
    <link rel="stylesheet" href="~/css/customer/booking/booking.css" asp-append-version="true" />
}

@Html.AntiForgeryToken()

<!-- Step Indicator -->
<div class="step-indicator">
    <div class="container">
        <div class="row">
            <div class="col-3">
                <div class="step-item active">
                    <div class="step-icon">
                        <i class="fas fa-th"></i>
                    </div>
                    <span>Chọn ghế</span>
                </div>
            </div>
            <div class="col-3">
                <div class="step-item">
                    <div class="step-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <span>Bắp nước</span>
                </div>
            </div>
            <div class="col-3">
                <div class="step-item">
                    <div class="step-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <span>Thanh toán</span>
                </div>
            </div>
            <div class="col-3">
                <div class="step-item">
                    <div class="step-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <span>Thông tin vé</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fixed Action Buttons -->
<div class="action-buttons fade-in">
    <div class="row g-3">
        <div class="col-4">
            <a href="@Url.Action("Index", "Movie")" class="btn btn-custom btn-back w-100">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
        <div class="col-8">
            <a href="@Url.Action("Concession", "Booking")" class="btn btn-custom btn-continue w-100" id="continue-btn"
                disabled>
                <span class="d-md-none">
                    <span id="mobile-total">0</span>₫ |
                </span>
                <span>Tiếp tục</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container booking-content">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-4 order-lg-2">
            <!-- Movie Info -->
            <div class="movie-info-card fade-in">
                <div class="movie-title">Doraemon Movie 44: Nobita Và Cuộc Phiêu Lưu Vào Thế Giới Trong Tranh</div>
                <div class="cinema-name">Beta Đan Phượng</div>
                <div class="showtime">
                    <i class="fas fa-clock"></i> Suất <strong>11:00 27/06/2025</strong><br>
                    <i class="fas fa-map-marker-alt"></i> Phòng chiếu <strong>P3</strong> - Ghế <span
                        id="selected-seats">...</span>
                </div>
            </div>

            <!-- Total -->
            <div class="total-card fade-in">
                <div class="total-section-label">TỔNG ĐƠN HÀNG</div>
                <div class="total-amount">
                    <span id="total-amount">0</span> ₫
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-8 order-lg-1">
            <div class="cinema-hall fade-in">
                <!-- Screen -->
                <div class="screen">
                    <i class="fas fa-tv me-2"></i>MÀN HÌNH
                </div>

                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-seat selected"></div>
                        <span>Ghế bạn chọn</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-seat taken"></div>
                        <span>Đã bán</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-seat unavailable"></div>
                        <span>Không thể chọn</span>
                    </div>
                </div>

                <!-- Seat Map -->
                <div class="seat-map" id="seat-map">
                    <!-- Seats will be generated by JavaScript -->
                </div>

                <!-- Seat Types Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-seat standard"></div>
                        <span>Standard (70,000₫)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-seat vip"></div>
                        <span>VIP (100,000₫)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-seat couple"></div>
                        <span>Couple (150,000₫)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/customer/booking/movie-booking.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize seats
            if (typeof initializeSeats === 'function') {
                initializeSeats();
            }

            // Handle continue button click
            document.getElementById('continue-btn').addEventListener('click', function (e) {
                e.preventDefault();

                if (selectedSeats && selectedSeats.length > 0) {
                    // Save seat selection data before navigating
                    const seatData = {
                        selectedSeats: selectedSeats.map(s => s.id).join(', '),
                        totalAmount: calculateTotalAmount().toLocaleString('vi-VN'),
                        seatCount: selectedSeats.length.toString(),
                        seatTotal: selectedSeats.reduce((sum, seat) => sum + seat.price, 0).toLocaleString('vi-VN')
                    };

                    // Send data to server
                    fetch('@Url.Action("SaveSeatSelection", "Booking")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify(seatData)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Navigate to concession page
                                window.location.href = this.href;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // Navigate anyway
                            window.location.href = this.href;
                        });
                } else {
                    alert('Vui lòng chọn ít nhất một ghế');
                }
            });
        });
    </script>
}
